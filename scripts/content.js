class KeyboardState{constructor(){this.open=!1,this.shift=!1,this.alphabet=1}toggleShift(){let e=document.getElementById("jp-web-keyboard-shadow").shadowRoot;if(!e||!this.open)return;this.shift=!this.shift;let t=e.querySelector('.key-action[data-action="shift"]'),a=e.querySelector(".keyboard");this.shift?(t.classList.add("active"),a.classList.add("shifted")):(t.classList.remove("active"),a.classList.remove("shifted"))}toggleOpen(){let e=document.getElementById("jp-web-keyboard-shadow").shadowRoot;if(!e)return;this.open=!this.open;let t=e.querySelector(".container");this.open?t.classList.add("active"):t.classList.remove("active")}cycleAlphabets(){let e=document.getElementById("jp-web-keyboard-shadow").shadowRoot;if(!e||!this.open)return;let t=e.querySelector('.key-action[data-action="cycle"]');t.querySelector(`.alphabet-${this.alphabet}`).classList.remove("active"),this.alphabet=(this.alphabet-1^1)+1,t.querySelector(`.alphabet-${this.alphabet}`).classList.add("active"),renderAlphabet()}}const action_keys={toggleOpen:{ctrlKey:!0,code:"KeyI"},toggleShift:{ctrlKey:!1,code:"ShiftLeft"},cycleAlphabets:{ctrlKey:!1,code:"Tab"}},state=new KeyboardState;function start(){let e=renderShadow();window.addEventListener("keydown",e=>{eventRouter(e)}),window.addEventListener("keyup",e=>{eventRouter(e)}),e.querySelector(".keyboard").addEventListener("mousedown",e=>{eventRouter(e)})}function eventRouter(e){if("mousedown"===e.type){e.preventDefault();let t=e.target.dataset.action,a=e.target.classList.contains("key"),s=e.target.dataset.code;if(s&&animateKey({code:s}),t){let r=e.target.dataset.action;switch(r){case"shift":state.toggleShift();return;case"cycle":state.cycleAlphabets();return;case"delete":backspace();return;case"semi-voiced":if(!state.shift){voiced({target:document.activeElement,code:"BracketLeft"});return}case"voiced":if(!state.shift){voiced({target:document.activeElement,code:"BracketRight"});return}}}a&&state.shift?(dispatch({target:document.activeElement},e.target.dataset.shift),state.toggleShift()):a&&dispatch({target:document.activeElement},e.target.dataset.value)}else if("keydown"===e.type){if(mapKeyboardEvent(e,action_keys.toggleOpen)){e.preventDefault(),state.toggleOpen();return}if(!state.open)return;if(animateKey(e),mapKeyboardEvent(e,action_keys.toggleShift)){e.preventDefault(),state.toggleShift();return}if(mapKeyboardEvent(e,action_keys.cycleAlphabets)){e.preventDefault(),state.cycleAlphabets();return}if(e.code.includes("Bracket")&&!state.shift){e.preventDefault(),voiced(e);return}else if(jp_layout[e.code]&&!e.ctrlKey){e.preventDefault(),dispatch(e,translate(e));return}}else if("keyup"==e.type&&mapKeyboardEvent(e,action_keys.toggleShift)){state.shift=!0,state.toggleShift();return}}function mapKeyboardEvent(e,t){return e.code==t.code&&e.ctrlKey==t.ctrlKey}function translate(e){let t=jp_layout[e.code][0],a=t[state.alphabet-1]||"",s=t[state.alphabet+1]||"";return state.shift?s:a}function dispatch(e,t,a=!1){let s=e.target.selectionStart,r=e.target.selectionEnd;if(void 0===e.target.value)return;let i=e.target.value.substring(0,s),n=e.target.value.substring(r);a&&(i=i.slice(0,-1)),e.target.value=i+t+n;let l=a?s:s+1;e.target.setSelectionRange(l,l)}function voiced(e){let t="BracketLeft"==e.code?0:1,a=e.target.selectionStart;if(!a)return;let s=e.target.value.substring(a-1,a),r;for(let i in jp_layout)(jp_layout[i][0].includes(s)||jp_layout[i][state.alphabet].includes(s))&&(r=i);if(!r)return;let n=jp_layout[r][state.alphabet][t];n&&dispatch(e,n,!0)}function backspace(){let e=document.activeElement;if(void 0===e.value)return;let t=e.selectionStart,a=e.selectionEnd,s=t==a?t-1:t;e.value=e.value.substring(0,s)+e.value.substring(a),e.setSelectionRange(s,s)}function renderShadow(){let e=document.createElement("div");e.id="jp-web-keyboard-shadow",document.body.append(e);let t=e.attachShadow({mode:"open"}),a=document.createElement("div");return a.innerHTML=keyboard_extension_template,t.appendChild(a),renderAlphabet(),t}function renderAlphabet(){let e=document.getElementById("jp-web-keyboard-shadow").shadowRoot;if(!e)return;let t=e.querySelectorAll(".key"),a=0;for(let s in jp_layout){let r=jp_layout[s][0][state.alphabet-1],i=jp_layout[s][0][state.alphabet+1];t[a].innerHTML=`<span class="shift">${i||"&nbsp;"}</span><span class="value">${r}</span>`,t[a].dataset.code=`${s}`,t[a].dataset.value=`${r}`,t[a].dataset.shift=`${i}`,a++}}function animateKey(e){let t=document.getElementById("jp-web-keyboard-shadow").shadowRoot;if(!t)return;let a=t.querySelector(`li[data-code="${e.code}"]`);a&&(a.classList.add("active"),setTimeout(()=>{a.classList.remove("active")},200))}start();